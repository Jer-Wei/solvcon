cache:
  directory:
  - $HOME/miniconda

# If using C++11/14 see http://genbattle.bitbucket.org/blog/2016/01/17/c++-travis-ci/
addons:
  apt:
    packages:
      - openssh-client
      - openssh-server
      - liblapack-pic
      - liblapack-dev

notifications:
  slack:
    rooms:
      secure: bW29JOqmFy0GnsX5epQDSA6vf4urxXTjxx+a7saHLKel3+VjBZvAUNRXC9tKNp6SkmIReuRAccCKe5XjWnadSxn6/mmUxWS/w+D95flTs8AFjycglr8rNLf8CQsjtg3IrcxuSoh9BJNbf7Ae/bqJ0LZSf8hdsQnSKHd7BxFuld8Pevtf2mwte97hVeO5xyCZH/dGvhTUzl8Ygzn+cZBNGwkh6rUwn2H2eIN9azoVzHVlvvPWg7IZC1L48CkijXqWgm1mhxQMRDyPw7UjABuORTCF3py7gUrib9AP67uSyU1oxIovehMtQ8WhbE7WXqX3RASm/NgP9dbXPo8nF5qe2vNzCVD1Y2y0EGVnvq38cLVIGS97NCm/Njnlb7nGqpWPhx1i0VnlxqD0uqmOxcolqnVQuw41+a+ZsH0OwCWg6xRJhSSdZxAZm8z88U1LhpJX5tfOlbV47ZoBA+0Gf+F3FFzu/k6TO8vdaeDrdBuzlaMrHZdVe42Wd0JGnvUToEzCRklvjMuPNGfsPrtAFfYzPhaZ53VGGW4nS1/x5bjTCN6BvFrSErFkUCrmfvee9+ltMovbw/b/wchnnyPX0X1qfseaDZIQ6860A7D6Tcv6DnrnflfbLLhZkfuGGkRhKAmASdB8gGBpgNJVoeAXbdJVJCJCSPCxMN1B15dZdHNvzfc=
    on_success: always  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/b446fff58c8ee17b216d
    on_success: always  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always

env:
  global:
    # Disable GCE boto plugin which is incompatible to Python 3, see
    # https://github.com/travis-ci/travis-ci/issues/5246
    - BOTO_CONFIG=/tmp/nowhere

matrix:
  include:
    - os: linux
      sudo: required
      dist: trusty
      language: cpp
      compiler: gcc
    - os: osx
      #osx_image: xcode7.3
      language: cpp
      compiler: clang

before_install:
  # Configure ssh
  - ssh-keygen -t rsa -f ~/.ssh/id_rsa -N ""
  - chmod 700 ~/.ssh/
  - cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
  - chmod 600 ~/.ssh/authorized_keys
  - ssh-keyscan -t rsa localhost >> ~/.ssh/known_hosts
  - ssh-keyscan -t rsa 127.0.0.1 >> ~/.ssh/known_hosts
  - chmod 600 ~/.ssh/known_hosts
  - ls -al ~/.ssh/
  - ssh localhost ls
  - ssh 127.0.0.1 ls
  # Install minimal conda
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O miniconda.sh;
    else
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - hash -r
  - conda config --set always_yes yes --set changeps1 no
  - conda update -q conda
  # Useful for debugging any issues with conda
  - which python; python --version
  - conda info -a
  # Debug information of compiler
  - which $CXX; $CXX --version
  - which $CC; $CC --version

install:
  - ${TRAVIS_BUILD_DIR}/contrib/devenv/create.sh
  - source ${TRAVIS_BUILD_DIR}/build/env/start
  - ${TRAVIS_BUILD_DIR}/contrib/conda.sh
  - ${TRAVIS_BUILD_DIR}/contrib/build-pybind11-in-conda.sh
  - which python; python --version
  - conda info -a
  - set | grep SC
  - set | grep CONDA

script:
  # C++ debug build
  - mkdir -p ${TRAVIS_BUILD_DIR}/build/debug
  - cd ${TRAVIS_BUILD_DIR}/build/debug
  - cmake -DPYTHON_EXECUTABLE:FILEPATH=`which python` -Dpybind11_DIR=${CONDA_PREFIX}/share/cmake/pybind11 -DTESTFILTER="*" -DCMAKE_BUILD_TYPE=Debug ${TRAVIS_BUILD_DIR}
  - cd ${TRAVIS_BUILD_DIR}
  - make -C build/debug run_gtest VERBOSE=1
  # Package
  - cd ${TRAVIS_BUILD_DIR}
  - contrib/release.sh
